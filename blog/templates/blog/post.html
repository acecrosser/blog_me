{% extends "base.html" %}
{% load selfilters %}

{% block content %}

    <h1>{{ post.title }}</h1>
    {{ post.update|date }} <br>
    {{ post.body|markdown }} <br>
    {{ post.rubric_name }} <br>
    {{ post.author }} <br><br>

    <a href="{% url 'blog:edit_post' post.slug %}">Редактировать</a>
    <br><br>

    <script>
    function like()
    {
        var like = $(this);
        var type = like.data('type');
        var pk = like.data('id');
        var action = like.data('action');
        var dislike = like.next();

        $.ajax({
            url : "/api/" + type +"/" + pk + "/" + action + "/",
            type : 'POST',
            data : { 'obj' : pk },

            success : function (json) {
                like.find("[data-count='like']").text(json.like_count);
                dislike.find("[data-count='dislike']").text(json.dislike_count);
            }
        });

        return false;
    }

    function dislike()
    {
        var dislike = $(this);
        var type = dislike.data('type');
        var pk = dislike.data('id');
        var action = dislike.data('action');
        var like = dislike.prev();

        $.ajax({
            url : "/api/" + type +"/" + pk + "/" + action + "/",
            type : 'POST',
            data : { 'obj' : pk },

            success : function (json) {
                dislike.find("[data-count='dislike']").text(json.dislike_count);
                like.find("[data-count='like']").text(json.like_count);
            }
        });

        return false;
    }

    $(function() {
        $('[data-action="like"]').click(like);
        $('[data-action="dislike"]').click(dislike);
    });
    </script>
    <ul>
    <li data-id="{{ post.id }}" data-type="blogpost" data-action="like" title="Нравится">
        <span class="btn btn-primary">Нра</span>
        <span data-count="like">{{ like_obj.votes.likes.count }}</span>
    </li>
    <li data-id="{{ post.id }}" data-type="blogpost" data-action="dislike" title="Не нравится">
        <span class="btn btn-primary">Ненра</span>
        <span data-count="dislike">{{ like_obj.votes.dislikes.count }}</span>
    </li>
    </ul>


    {% for cmnt in comments %}
        {{ cmnt.comment }}
        {{ cmnt.author }}
        {{ cmnt.create }} <br><br><br><br>
    {% endfor %}

    <form method="post">
        <table>
            {% csrf_token %}
            {{ comment_form.as_table }}
        </table>
        <input type="submit" value="Добавить комментарий">
    </form>
    <br><br><br><br>
{% endblock %}